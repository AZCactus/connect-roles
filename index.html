<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Connect-roles : Provides dynamic roles based authentication for node.js connect and express servers." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Connect-roles</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ForbesLindesay/connect-roles">View on GitHub</a>

          <h1 id="project_title">Connect-roles</h1>
          <h2 id="project_tagline">Provides dynamic roles based authentication for node.js connect and express servers.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ForbesLindesay/connect-roles/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ForbesLindesay/connect-roles/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>Connect roles is designed to work with connect or express.  It is an authorisation provider, not an authentication provider.  It is designed to support context sensitive roles/abilities, through the use of middleware style authorisation strategies.</p>

<p>If you're looking for an authentication system I suggest you check out <a href="https://github.com/jaredhanson/passport">passport.js</a></p>

<h2>Installation</h2>

<pre><code>$ npm install connect-roles
</code></pre>

<h2>Usage</h2>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">authentication</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'your-authentication-module-here'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'connect-roles'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">authentication</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>

<span class="c1">//anonymous users can only access the home page</span>
<span class="c1">//returning false stops any more rules from being</span>
<span class="c1">//considered</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">)</span> <span class="k">return</span> <span class="nx">action</span> <span class="o">===</span> <span class="s1">'access home page'</span><span class="p">;</span>
<span class="p">})</span>

<span class="c1">//moderator users can access private page, but</span>
<span class="c1">//they might not be the only one so we don't return</span>
<span class="c1">//false if the user isn't a moderator</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'access private page'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">====</span> <span class="s1">'moderator'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">//admin users can access all pages</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s1">'admin'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//optionally controll the access denid page displayed</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">setFailureHandler</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">action</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">accept</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">accept</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">accept</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'html'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'access-denied'</span><span class="p">,</span> <span class="p">{</span><span class="nx">action</span><span class="o">:</span> <span class="nx">action</span><span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Access Denied - You don\'t have permission to: '</span> <span class="o">+</span> <span class="nx">action</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">can</span><span class="p">(</span><span class="s1">'access home page'</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'private'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/private'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">can</span><span class="p">(</span><span class="s1">'access private page'</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'private'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">can</span><span class="p">(</span><span class="s1">'access admin page'</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>

<h2>API</h2>

<h3>roles.use(fn(req, action))</h3>

<p>Define and authorisation strategy which takes the current request and the action being performed.  fn may return <code>true</code>, <code>false</code> or <code>undefined</code>/<code>null</code></p>

<p>If <code>true</code> is returned then no further strategies are considred, and the user is <strong>granted</strong> access.</p>

<p>If <code>false</code> is returned, no further strategies are considered, and the user is <strong>denied</strong> access.</p>

<p>If <code>null</code>/<code>undefined</code> is returned, the next strategy is considerd.  If it is the last strategy then access is <strong>denied</strong>.</p>

<h3>roles.use(action, fn(req))</h3>

<p>The strategy <code>fn</code> is only used when the action is equal to <code>action</code>.  It has the same behaviour with regards to return values as <code>roles.use(fn(req, action))</code> (see above).</p>

<p>It is equivallent to calling:</p>

<div class="highlight"><pre>  <span class="nx">roles</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">act</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">act</span> <span class="o">===</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></div>

<p><strong>N.B.</strong> The action must not start with a <code>/</code> character or it will call <code>roles.use(path, fn(req, action))</code></p>

<h3>roles.use(action, path, fn(req))</h3>

<p>Path must be an express style route.  It will then attach any parameters to <code>req.params</code>.</p>

<p>e.g.</p>

<div class="highlight"><pre><span class="nx">roles</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'edit user'</span><span class="p">,</span> <span class="s1">'/user/:userID'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userID</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<p>Note that this authorisation strategy will only be used on routes that match <code>path</code>.</p>

<p>It is equivallent to calling:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">exp</span> <span class="o">=</span> <span class="nx">pathToRegexp</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
<span class="nx">roles</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">act</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">match</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">act</span> <span class="o">===</span> <span class="nx">action</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">path</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">req</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span> <span class="o">||</span> <span class="p">{});</span>
    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<h3>roles.can(action) and roles.is(action)</h3>

<p><code>can</code> and <code>is</code> are synonyms everywhere they appear.</p>

<p>You can use these as express route middleware:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">roles</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/profile/:id'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">can</span><span class="p">(</span><span class="s1">'edit profile'</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'profile-edit'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
<span class="p">})</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h3>req.user.can(action) and req.user.is(action)</h3>

<p><code>can</code> and <code>is</code> are synonyms everywhere they appear.</p>

<p>These functions return <code>true</code> or <code>false</code> depending on whether the user has access.</p>

<p>e.g.</p>

<div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'home/admin'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">can</span><span class="p">(</span><span class="s1">'login'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'home/login'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'home'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>

<h3>user.can(action) and user.is(action)</h3>

<p>Inside the views of an express application you may use <code>user.can</code> and <code>user.is</code> which are equivallent to <code>req.user.can</code> and <code>req.user.is</code></p>

<p>e.g.</p>

<div class="highlight"><pre><span class="err">&lt;</span>% if (user.can('impersonate')) { %&gt;
  <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"impersonate"</span><span class="nt">&gt;</span>Impersonate<span class="nt">&lt;/button&gt;</span>
<span class="err">&lt;</span>% } %&gt;
</pre></div>

<p><strong>N.B.</strong> not displaying a button doesn't mean someone can't do the thing that the button would do if clicked.  The view is not where your security should go, but it is important for useability that you don't display buttons that will just result in 'access denied' where possible.</p>

<h3>roles.setFailureHandler(fn(req, res, action))</h3>

<p>You can (and should) set the failure handler.  This is called whenever a user fails authorisation in route middleware.</p>

<p>Defaults to:</p>

<div class="highlight"><pre><span class="nx">user</span><span class="p">.</span><span class="nx">setFailureHandler</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">action</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>There is no "next" by design, to stop you accidentally calling it and allowing someone into a restricted part of your site.  You are passed the action requested which caused them to be denied access.</p>

<p>You could using this to redirect the user or render an error page:</p>

<div class="highlight"><pre><span class="nx">user</span><span class="p">.</span><span class="nx">setFailureHandler</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">action</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">accept</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">accept</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">accept</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'html'</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'access-denied'</span><span class="p">,</span> <span class="p">{</span><span class="nx">action</span><span class="o">:</span> <span class="nx">action</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Access Denied - You don\'t have permission to: '</span> <span class="o">+</span> <span class="nx">action</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<h2>License</h2>

<p>MIT</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Connect-roles maintained by <a href="https://github.com/ForbesLindesay">ForbesLindesay</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-34130504-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
